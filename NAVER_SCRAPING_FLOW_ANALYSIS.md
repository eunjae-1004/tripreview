# 네이버맵 스크래핑 로직 순서 분석

## 사용자가 요청한 순서

1. ✅ 기업명 기준으로 사이트 검색
2. ✅ 더보기 버튼 클릭
3. ✅ 해당 페이지로 이동
4. ✅ 최신순으로 선택
5. **첫번째 목록부터 자료를 수집**
   - 수집할때 content 부분에 더보기 버튼 클릭하면 추가 정보 확인해서 가져오고
   - **한건의 자료 수집이 끝났으면 DB에 저장하고**
6. **스크롤을 내리면서 다음 목록 읽어서 반복하고**
7. **현재페이지의 목록이 끝나면 더보기 버튼을 클릭해 더 많은 목록 읽어오고**

---

## 현재 코드의 실제 순서

### 1단계: 초기 설정 (393-531줄)
- ✅ 기업명으로 네이버 검색 (399줄)
- ✅ 더보기 버튼 클릭하여 네이버맵 페이지로 이동 (404-485줄)
- ✅ 네이버맵 페이지 로딩 (487-488줄)
- ✅ iframe 찾기 (490-531줄)
- ✅ 리뷰 탭 클릭 (498-505줄)
- ✅ 최신순 정렬 클릭 (507-526줄)

### 2단계: 🔴 문제 지점 - 더보기 버튼을 모두 클릭 (662-871줄)
**현재 코드는 여기서 모든 더보기 버튼을 클릭하여 모든 리뷰를 로드합니다.**

```javascript
// 662-871줄: 더보기 버튼 클릭 루프
while (moreButtonExists && clickCount < maxClicks) {
  // 리뷰 목록을 더 불러오는 더보기 버튼 클릭
  // 리뷰 내용 더보기 버튼 클릭
  // 키워드 펼쳐보기 버튼 클릭
  // ... 모든 버튼을 클릭하여 모든 리뷰 로드
}
```

**문제점:**
- 모든 더보기 버튼을 먼저 클릭하여 모든 리뷰를 로드
- 이 시점에는 아직 리뷰를 추출하지 않음
- 메모리에 모든 리뷰를 로드한 후에야 추출 시작

### 3단계: 최종 리뷰 개수 확인 (873-921줄)
- 더보기 버튼 클릭이 끝난 후 리뷰 개수 확인
- `authorButtonCount`에 총 리뷰 개수 저장

### 4단계: 리뷰 추출 루프 (928-1705줄)
- `for (let i = 0; i < maxReviews; i++)` 루프로 각 리뷰 추출
- 각 리뷰마다:
  - 닉네임, 평점, 날짜 추출
  - content 더보기 버튼 클릭 (1413-1431줄) ✅
  - 키워드 펼쳐보기 버튼 클릭 (1509-1524줄) ✅
  - 즉시 저장 (1602-1682줄) ✅

---

## 🔴 발견된 주요 문제점

### 문제 1: 더보기 버튼을 모두 클릭한 후 리뷰 추출
**현재 순서:**
```
더보기 버튼 모두 클릭 (662-871줄)
  ↓
최종 리뷰 개수 확인 (873-921줄)
  ↓
리뷰 추출 루프 시작 (928줄)
  ↓
각 리뷰 추출 및 저장 (928-1705줄)
```

**요청하신 순서:**
```
첫 번째 리뷰 추출
  ↓
content 더보기 버튼 클릭
  ↓
DB 저장
  ↓
두 번째 리뷰 추출
  ↓
content 더보기 버튼 클릭
  ↓
DB 저장
  ↓
...
  ↓
현재 페이지의 모든 리뷰가 끝나면
  ↓
더보기 버튼 클릭 (다음 페이지 로드)
  ↓
다음 페이지의 첫 번째 리뷰 추출
  ↓
반복...
```

### 문제 2: 스크롤 로직이 없음
- 현재 코드는 더보기 버튼을 클릭하기 전에 스크롤을 하지만 (685-698줄)
- 리뷰 추출 루프에서는 스크롤하지 않음
- 각 리뷰를 추출할 때마다 스크롤하여 다음 리뷰를 보이게 해야 함

### 문제 3: 더보기 버튼 클릭 타이밍
- 현재: 모든 더보기 버튼을 먼저 클릭
- 요청: 현재 페이지의 모든 리뷰를 수집한 후에만 더보기 버튼 클릭

---

## 수정 방안

### 새로운 순서 (요청하신 순서대로)

```
1. 기업명 검색
2. 더보기 버튼 클릭하여 네이버맵 페이지로 이동
3. 최신순 선택
4. 리뷰 추출 루프 시작:
   while (true) {
     // 현재 페이지의 리뷰 개수 확인
     const currentReviews = getCurrentReviewCount();
     
     for (let i = 0; i < currentReviews; i++) {
       // 리뷰 컨테이너 찾기
       const container = getReviewContainer(i);
       
       // 스크롤하여 리뷰가 보이도록 함
       await scrollToReview(container);
       
       // 닉네임, 평점, 날짜 추출
       const nickname = extractNickname(container);
       const rating = extractRating(container);
       const date = extractDate(container);
       
       // content 더보기 버튼 클릭
       await clickContentMoreButton(container);
       
       // content 추출
       const content = extractContent(container);
       
       // 키워드 펼쳐보기 버튼 클릭
       await clickKeywordMoreButton(container);
       
       // 키워드 추출
       const keywords = extractKeywords(container);
       
       // 한건의 자료 수집이 끝났으면 DB에 저장
       await saveReview({
         companyName,
         nickname,
         rating,
         date,
         content,
         keywords,
         ...
       });
       
       // 다음 리뷰로 스크롤
       await scrollToNextReview();
     }
     
     // 현재 페이지의 모든 리뷰를 수집했으면
     // 더보기 버튼 클릭하여 다음 페이지 로드
     const hasMoreButton = await checkMoreButton();
     if (!hasMoreButton) {
       break; // 더 이상 리뷰가 없음
     }
     
     await clickMoreButton(); // 다음 페이지 로드
     await waitForNewReviews(); // 새 리뷰 로딩 대기
   }
```

---

## 수정이 필요한 부분

1. **더보기 버튼 클릭 루프 제거 (662-871줄)**
   - 현재 페이지의 리뷰를 모두 수집한 후에만 더보기 버튼 클릭하도록 변경

2. **리뷰 추출 루프 수정 (928-1705줄)**
   - 각 리뷰 추출 전에 스크롤 추가
   - 각 리뷰 추출 후 즉시 저장 (이미 구현됨)
   - 현재 페이지의 모든 리뷰를 수집한 후 더보기 버튼 클릭

3. **페이지 단위 처리**
   - 현재 페이지의 리뷰 개수를 동적으로 확인
   - 더보기 버튼 클릭 후 새 리뷰가 로드될 때까지 대기
   - 새 리뷰부터 다시 추출 시작

---

## 예상되는 개선 효과

1. **메모리 효율성 향상**
   - 모든 리뷰를 한 번에 로드하지 않고 필요할 때만 로드

2. **안정성 향상**
   - 각 리뷰를 추출할 때마다 저장하므로 중간에 실패해도 이미 저장된 데이터는 보존

3. **진행 상황 추적 용이**
   - 각 리뷰를 저장할 때마다 로그가 출력되어 진행 상황을 실시간으로 확인 가능

---

## 날짜 필터링 종료 로직 확인

### 현재 날짜 필터링 동작 (1371-1375줄, 1617-1627줄)

**현재 코드:**
```javascript
// 날짜 필터링: week 또는 twoWeeks 모드일 때 필터링
if ((dateFilter === 'week' || dateFilter === 'twoWeeks') && filterDate && reviewDate && reviewDate < filterDate) {
  // 필터 날짜 이전 리뷰는 건너뜀
  continue;  // ❌ 스킵만 하고 계속 진행
}
```

**문제점:**
- 필터 범위를 벗어난 날짜를 만나도 `continue`로 스킵만 함
- 더보기 버튼을 계속 클릭하여 모든 리뷰를 로드하려고 시도
- 최신순으로 정렬되어 있으므로, 필터 범위를 벗어난 날짜를 만나면 그 이후의 모든 리뷰도 범위를 벗어남
- **불필요하게 모든 리뷰를 로드하려고 시도하여 시간 낭비**

### 요청하신 동작

**1주/2주 간격 지정 시:**
- 필터 범위를 벗어난 날짜를 만나면 **즉시 자료수집 종료**
- 최신순으로 정렬되어 있으므로, 필터 범위를 벗어난 날짜 이후의 모든 리뷰도 범위를 벗어남
- 따라서 필터 범위를 벗어난 날짜를 만나면 루프를 종료해야 함

### 수정 방안

**새로운 날짜 필터링 로직:**
```javascript
// 날짜 필터링: week 또는 twoWeeks 모드일 때 필터링
if ((dateFilter === 'week' || dateFilter === 'twoWeeks') && filterDate && reviewDate) {
  if (reviewDate < filterDate) {
    // 필터 범위를 벗어난 날짜를 만남
    // 최신순으로 정렬되어 있으므로, 이후의 모든 리뷰도 범위를 벗어남
    console.log(`[네이버맵] 날짜 필터 범위를 벗어남: ${date} < ${filterDate.toISOString().split('T')[0]}`);
    console.log(`[네이버맵] 최신순 정렬이므로 이후 모든 리뷰도 범위를 벗어남. 자료수집 종료.`);
    break; // ✅ 루프 종료 (continue가 아님)
  }
}
```

**적용 위치:**
1. 리뷰 추출 루프 내 날짜 필터링 (1371-1375줄)
2. 즉시 저장 전 날짜 필터링 (1617-1627줄)

**주의사항:**
- 최신순으로 정렬되어 있으므로, 필터 범위를 벗어난 날짜를 만나면 그 이후의 모든 리뷰도 범위를 벗어남
- 따라서 `break`로 루프를 종료해야 함
- `continue`는 사용하지 않음 (불필요한 처리 방지)
